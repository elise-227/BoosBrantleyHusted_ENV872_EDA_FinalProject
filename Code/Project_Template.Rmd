---
output: 
  pdf_document:
    keep_tex: yes
    fig_caption: yes
    number_sections: yes
geometry: margin=2.54cm
title: "Insert title of project here"
subtitle: "Web address for GitHub repository"
author: "Elise Boos, Andrew Brantley, Kelsey Husted"
fontsize: 12pt
mainfont: Times New Roman
editor_options: 
  chunk_output_type: console
---

\newpage
\tableofcontents 
\newpage
\listoftables 
\newpage
\listoffigures 
\newpage

```{r setup, include=FALSE}
# Set your working directory
getwd()

# Load your packages
library(tidyverse)
library(lubridate)
library(zoo)
library(trend)
library(dygraphs)
library(xts)
library(ggfortify)
require(dplyr)
library(Kendall)
library(tseries)
require(sf)
require(leaflet)
require(mapview)
library(plyr)
mapviewOptions(fgb = FALSE)

# Set your ggplot theme

my_theme <- theme_classic(base_size = 14) +
  theme(axis.text = element_text(color = "black"), 
        legend.position = "bottom", legend.text=element_text(size=8), 
        legend.title=element_text(size=10), panel.background = element_rect(fill = "gray95"), 
        panel.grid.major = element_line(size = 0.6, linetype = 'solid', colour = "white"))

theme_set(my_theme)

# Load your datasets
#New York Data
NY_Discharge <- read.csv("../Data/Raw/NY_MeanDailyDischarge.csv", stringsAsFactors = TRUE)

#North Carolina Data
NC_Discharge <- read.csv("../Data/Raw/NC_Discharge_NewRiver_RAW.csv", stringsAsFactors = TRUE)

#Florida data
#read in both sheets of the data since data was too big to fit on one
florida_part2 <- read.csv("../Data/Raw/florida_round2.csv", stringsAsFactors = T)
florida_part2_join <- read.csv("../Data/Raw/florida_round2_1.csv", stringsAsFactors = T)
#join the two datasets
join <- rbind(florida_part2, florida_part2_join)
```


# Rationale and Research Questions

Hurricanes are a serious natural disaster that often affects millions each year up and down the East Coast of the United States. Understanding how climate change is impacting the trends of hurricanes will be important information for strategic planning to protect both property and lives into the future. For this analysis we chose to look at discharge data of major rivers in states spanning the East Coast of the US in order to gain ome information on how locality and intensity of these hurricanes may be changing over the past three decades. 

We chose to investigate discharge data in Florida, North Carolina, and New York to gain an understanding of how hurricane regimes may be changing across the entire span of the coast. Furthermore, the comparative study will reveal if hurricanes are shifting poleward. Our central research questions revolved around investigating any increasing trends in discharge during the hurricane season (June-October) and where these increasing trends were more intense. 

## Research Questions

## Question 1: Has there been an overall increase in mean daily discharge during the Atlantic hurricane season from 1990 - 2021?

## Question 2: Has one portion of the East Coast of the US experienced a disproportionate increase in hurricane activity, and its associated discharge, compared to other portions commonly affected by these hurricanes?

## Question 3: Are the general locations of hurricanes shifting towards the poles in the northern &/or southern hemisphere?

\newpage

# Dataset Information

All datasets used in this analysis were downloaded from the USGS website, specifically from their historical records of discharge data recorded by field dataloggers. The data was obtained from three states varying in latitude along the East Coast (i.e., Florida, North Carolina, and New York). Stream gage locations were selected based on proximity to major river basins and vulnerable counties susceptible to hurricane impacts. Additionally, Gage locations were chosen with sufficient data, going back to at least the 1990s. Similar timeline ranges for the datatsets ensures a time series analysis that is comparable among all three sites. Discharge data was the data type used in this analysis with all datasets having at minimum daily recordings but some having recordings as often as every 30 minutes. 

\newpage

#Data Wrangling
```{r NY Wrangle}

```

```{r NC Wrangle}
# initial tidying of dataset
NewRiver.Discharge.RAW <- NewRiver.Discharge.RAW[-c(1), ] #removing non-data row

NewRiver.Discharge.PROC <- NewRiver.Discharge.RAW %>% 
                        select(agency_cd, site_no, 
                               X89345_00060, X89346_00065, Date) #selecting necessary columns

colnames(NewRiver.Discharge.PROC) <- c("Agency", "Site_No",
                            "Discharge_cfs", "GageHeight_ft", "Date") #changing column names
  
# setting discharge and gage height columns as numeric
NewRiver.Discharge.PROC$Discharge_cfs <- as.numeric(NewRiver.Discharge.PROC$Discharge_cfs)
NewRiver.Discharge.PROC$GageHeight_ft <- as.numeric(NewRiver.Discharge.PROC$GageHeight_ft)

NewRiver.Discharge.PROC <- NewRiver.Discharge.PROC %>% 
                        group_by(Date) %>%  #grouping by date
                        mutate(Year = year(Date), #creating year column
                               Month = month(Date), #creating month column
                               Day = day(Date)) %>% #creating day column
                        filter(Year >= 1990) %>% #filtering for data 1990 or later
                      filter(Month > 5 & Month < 11) #filtering for data in hurricane season

# saving processd file as csv
write.csv(NewRiver.Discharge.PROC, "./Data/Processed/NC_Discharge_NewRiver_PROC.csv", row.names = FALSE)
                        
# creating daily discharge dataset
NewRiver.Daily.DischargeGage <- NewRiver.Discharge.PROC %>%  
            summarise(MeanDailyDischarge_cfs = mean(Discharge_cfs), #daily mean discharge
                      MeanDailyGageHeight_ft = mean(GageHeight_ft)) #daily mean gage height

# filling missing data with linear interpolation
NewRiver.Daily.Discharge.Clean <-
  NewRiver.Daily.DischargeGage %>%
  mutate(Discharge_cfs_Clean = zoo::na.approx(MeanDailyDischarge_cfs))
```

```{r FL Wrangle}
#clean the original florida dataset
florida_clean <- join %>%
  mutate(Date = ymd(Date)) %>%
  mutate(State = "Florida") %>%
  select(State, Date, Discharge)
#days with multiple observations summarise to get mean and filter out only hurricane months
florida_hurricane <- florida_clean %>%
  group_by(Date) %>%
  summarise(Daily_Discharge = mean(Discharge)) %>%
  mutate(month = month(Date)) %>%
  filter(month >= 6 & month <= 10) 
#create a date dataframe of timespan
Date  <- seq(as.Date("1987-01-01"),as.Date("2021-10-31"), by = "days")
Dates <- as.data.frame(Date)
#filter out hurricane months
date_join <- Dates %>%
  mutate(month = month(Date)) %>%
  filter(month >= 6 & month <= 10) %>%
  select(1)
#join the data sets to allow us to know which days don't have observations
#interpolate the days with NAs
fh_clean <-left_join(date_join, florida_hurricane, by = "Date")
fh_clean <- fh_clean %>%
  select(1,2) %>%
  mutate(Daily_Discharge_clean = zoo::na.approx(Daily_Discharge))
#save to processed folder 
write.csv(fh_clean, "../Data/Processed/flordia_1987_processed.csv")
#trimming data set for comparison, starting at 1990
florida_1990_edit <- fh_clean %>%
  mutate(year = year(Date)) %>%
  filter(year >= 1990) 
#save to processed folder 
write.csv(florida_1990_edit, "../Data/Processed/flordia_1990_processed.csv")
```


\newpage

# Exploratory Analysis 

```{r map of locations}
site_locations <- read.csv("../Data/Raw/Site_locations.csv", stringsAsFactors = T)
site_locations.sf <- site_locations %>%
st_as_sf(coords = c('Long','Lat'),
         crs=4269)
mapview(site_locations.sf[1,], zcol = "Site.Name", col.regions = "deeppink1") +
mapview(site_locations.sf[2,], zcol = "Site.Name", col.regions = "turquoise4") +
mapview(site_locations.sf[3,], zcol = "Site.Name", col.regions = "forestgreen")
```

```{r ex an FL}
#plot discharge before running time series on the log scale
ggplot(florida_1990_edit, aes(x = Date, y = log(Daily_Discharge_clean)))+
  geom_point(color = "deeppink1")+
  geom_smooth(method = lm, color = "black")+
  labs(title = "Discharge in Florida during Hurricane Months")+
  xlab("Date") +
  ylab("Mean Daily Discharge (cfs)")
  scale_y_discrete(c(0,1000))+
  
```

```{r ex an NC}
# initial data visualiation
DailyDischarge.Plot <- 
                ggplot(NewRiver.Daily.DischargeGage, aes(Date, MeanDailyDischarge_cfs)) +
                      geom_point(color = "forestgreen") +
                      geom_smooth(method = "lm", color = "black") +
                      labs(x = "Date", y = "Mean Daily Discharge (cfs)",
                        title = "Mean Daily Discharge During Hurrcane Seasons (1990-2021)", 
                           subtitle = "New River, North Carolina") +
                      theme(plot.title=element_text(hjust=0.5)) +
                      theme(plot.subtitle=element_text(hjust=0.5)) +
                      scale_y_log10()
DailyDischarge.Plot
```


\newpage

# Analysis
```{r NY analysis}

```

```{r NC analysis}
# creating daily discharge time series
NewRiver.Daily.Discharge.ts <- ts(NewRiver.Daily.Discharge.Clean$Discharge_cfs_Clean,
                     start = c(1990, 06, 01), frequency = 153)

# decomposing daily time series
Daily.Discharge.decomp <- stl(NewRiver.Daily.Discharge.ts, s.window = "periodic")
plot(Daily.Discharge.decomp)

# adding components into a dataframe, removing seasonal component
Daily.Discharge.Components <- as.data.frame(Daily.Discharge.decomp$time.series[,2:3])

# adding trend and remainder for analysis
NonSeasonalDischarge.Daily <- mutate(Daily.Discharge.Components,
                                   Seasonality_Removed = Daily.Discharge.Components$trend +
                                     Daily.Discharge.Components$remainder)

# creating non-seasonal time series
NonSeasonal.DailyDischarge.ts <- ts(NonSeasonalDischarge.Daily$Seasonality_Removed,
                     start = c(1990, 06, 01), frequency = 153)

# adding date column to nonseasonal df
NonSeasonalDischarge.Daily <- NonSeasonalDischarge.Daily %>% 
                                mutate(Date = NewRiver.Daily.Discharge.Clean$Date)

# creating nonseasonal plot
NonSeasonal.Plot <- ggplot(NonSeasonalDischarge.Daily, aes(Date, Seasonality_Removed)) +
                      geom_point(color = "forestgreen", size = 0.6) +
                      scale_y_log10() +
                      geom_smooth(method = "lm", color = "black") +
                      labs(x = "Date", y = "Non-Seasonal Daily Discharge (cfs)", 
                        title = "Non-Seasonal Mean Daily Discharge During Hurricane Seasons",
                        subtitle = "New River, North Carolina") +
                      scale_x_date(date_labels = "%Y", date_breaks = "2 year") +
                      theme(axis.text.x = element_text(angle = 90)) 
NonSeasonal.Plot

# running Mann Kendall on time series with seasonality removed
MannKendall(NonSeasonal.DailyDischarge.ts)
```

```{r FL analysis}
#regular time series
florida_hurricane_ts <- ts(florida_1990_edit$Daily_Discharge_clean, start=c(1990,6), frequency = 153)  
florida_hurricane_ts

#decomposed time series
florida_hurricane_Decomposed <- stl(florida_hurricane_ts, s.window = "periodic")
plot(florida_hurricane_Decomposed)
#filtering out seasonal data
florida_hurricane_Decomposed_Components <- as.data.frame(florida_hurricane_Decomposed$time.series[,2:3])
florida_hurricane_Decomposed_Components <- florida_hurricane_Decomposed_Components %>%
  mutate(data = trend + remainder) 
#add date column
florida_hurricane_Decomposed_Components <- mutate(florida_hurricane_Decomposed_Components,
                        Date = florida_1990_edit$Date)

#run time series on new data with seasonal removed
nonseasonal_data_florida_ts <- ts(florida_hurricane_Decomposed_Components$data,
                                start=c(1990,6),
                                frequency=153) 
plot(nonseasonal_data_florida_ts)

#look for trend and significance 
florida_trend <- MannKendall(nonseasonal_data_florida_ts)
florida_trend
summary(florida_trend)

#plot of nonseasonal trend
FL_NonSeasonal.Plot <- ggplot(florida_hurricane_Decomposed_Components, aes(x = Date, y = data)) +
  scale_y_log10() +
  geom_point(color = "deeppink1", size = 0.6) +
  labs(x = "Date", y = "Non-Seasonal Daily Discharge (cfs)", 
       title = "Non-Seasonal Mean Daily Discharge During Hurricane Seasons", 
       subtitle = "North Prong St. Sebastian River, Florida") +
  geom_smooth(method = "lm", color = "black") +
  scale_x_date(date_labels = "%Y", date_breaks = "2 year") +
  theme(axis.text.x = element_text(angle = 90)) 
plot(FL_NonSeasonal.Plot)                               
```

```{r combined plot}
# creating combined nonseasonal dataframe
Date.df <- as.data.frame(NY_Combine_Nonseasonal$Date)
NY.NonSeasonal.df <- as.data.frame(NY_Combine_Nonseasonal$Nonseasonal)
FL.NonSeasonal.df <- as.data.frame(florida_hurricane_Decomposed_Components$data)
NC.NonSeasonal.df <- as.data.frame(NonSeasonalDischarge.Daily$Seasonality_Removed)

Combined.Nonseasonal.DF <- merge(Date.df, NY.NonSeasonal.df, FL.NonSeasonal.df, NC.NonSeasonal.df)


combined_NonSeasonal.Plot <- ggplot(NULL) +
  scale_y_log10() +
  geom_point(data = NonSeasonalDischarge.Daily, aes(Date, Seasonality_Removed), 
             color = "forestgreen", alpha = 0.05) +
  geom_smooth(data = NonSeasonalDischarge.Daily, aes(Date, Seasonality_Removed),
              method = "lm", color = "forestgreen") +
  geom_point(data = florida_hurricane_Decomposed_Components, 
             aes(x = Date, y = data), color = "deeppink1", alpha = 0.05) +
  geom_smooth(data = florida_hurricane_Decomposed_Components, 
             aes(x = Date, y = data), method = "lm", color = "deeppink1") +
  geom_point(data = NY_Combine_Nonseasonal, aes(x = Date, y = Nonseasonal), 
             color = "turquoise4", alpha = 0.05) + 
  geom_smooth(data = NY_Combine_Nonseasonal, aes(x = Date, y = Nonseasonal), 
              method = "lm", color = "turquoise4") +
  labs(x = "Date", y = "Non-Seasonal Daily Discharge (cfs)", 
       title = "Non-Seasonal Mean Daily Discharge During Hurricane Seasons") +
  scale_x_date(date_labels = "%Y", date_breaks = "2 year") +
  theme(axis.text.x = element_text(angle = 90)) 
plot(combined_NonSeasonal.Plot)
```


\newpage

# Summary and Conclusions

There appears to be a poleward trend in hurricanes based on the trend in discharge values during hurricane months across the east coast. 

State           | Tau value     | P-value
--------------- | ------------- | ------------
New York        | 0.13          | =< 2.22e-16
North Carolina  | 0.0595        | =< 2.22e-16
Florida         | -0.0639       | 1.9569e-11



\newpage

# References
<add references here if relevant, otherwise delete this section> 
