---
title: "Hurricane Trends Along the East Coast"
author: "Elise Boos, Andrew Brantley, Kelsey Husted"
output:
  html_document:
    df_print: paged
  pdf_document:
    keep_tex: yes
    fig_caption: yes
    number_sections: yes
subtitle: https://github.com/elise-227/BoosBrantleyHusted_ENV872_EDA_FinalProject.git
geometry: margin=2.54cm
fontsize: 12pt
mainfont: Times New Roman
editor_options:
  chunk_output_type: console
---

\newpage
\tableofcontents 
\newpage
\listoftables 
\newpage
\listoffigures 
\newpage

```{r setup, include=FALSE}
#Set your working directory
getwd()

# Load your packages
library(tidyverse)
library(lubridate)
library(zoo)
library(trend)
library(dygraphs)
library(xts)
library(ggfortify)
require(dplyr)
library(Kendall)
library(tseries)
require(sf)
require(leaflet)
require(mapview)
library(plyr)
mapviewOptions(fgb = FALSE)

# Set your ggplot theme

my_theme <- theme_classic(base_size = 14) +
  theme(axis.text = element_text(color = "black"), 
        legend.position = "bottom", legend.text=element_text(size=8), 
        legend.title=element_text(size=10), panel.background = element_rect(fill = "gray95"), 
        panel.grid.major = element_line(size = 0.6, linetype = 'solid', colour = "white"))

theme_set(my_theme)

# Load your datasets

#New York Data
NY_Discharge <- read.csv("./Data/Raw/NY_MeanDailyDischarge.csv", stringsAsFactors = TRUE)
#Format Date
NY_Discharge$Date <- as.Date(NY_Discharge$Date, format = "%m/%d/%Y")

#North Carolina Data
NewRiver.Discharge.RAW <- read.csv("./Data/Raw/NC_Discharge_NewRiver_RAW.csv", stringsAsFactors = TRUE)
# setting date column as date
NewRiver.Discharge.RAW$Date <- as.Date(NewRiver.Discharge.RAW$datetime, format = '%m/%d/%y')

#Florida data
florida_hurricane_1990 <- read.csv("./Data/Processed/florida_hurricane_1990_processed.csv", 
                                   stringsAsFactors = T)
#setting date column as date 
florida_hurricane_1990$Date <- as.Date(florida_hurricane_1990$Date, format = '%Y-%m-%d')
```


# Rationale and Research Questions

Hurricanes are a serious natural disaster that affects millions each year along the East Coast of the United States. Furthermore, hurricanes create severe flooding, dangerous storm surges, and high winds that have long-lasting and devastating consequences on many communities. Understanding how climate change influences the trends of hurricanes will be informative for strategic planning to protect both property and lives in the future. For this analysis we chose to look at discharge data in the vicinity of major rivers in states spanning the East Coast of the US. The objective of the analysis is to gain valuable insight on how locality and intensity of these hurricanes may be changing over the past three decades. 

Discharge data in Florida, North Carolina, and New York will be used to gain a better understanding of how hurricane regimes change across the entire span of the coast through time. Furthermore, the comparative study will reveal if hurricanes are shifting poleward. Our central research questions revolve around investigating any increasing trends in discharge during the hurricane season (June-October) and where these increasing trends are more intense. 

## Research Questions

## Question 1: Has there been an overall increase in mean daily discharge during the Atlantic hurricane season from 1990 - 2021?

## Question 2: Has one portion of the East Coast of the US experienced a disproportionate increase in hurricane activity, and its associated discharge, compared to other portions commonly affected by these hurricanes?

## Question 3: Are the general locations of hurricanes shifting towards the poles in the northern &/or southern hemisphere?

\newpage

# Dataset Information

All datasets used in this analysis were downloaded from the United States Geological Survey (USGS) website, specifically from  historical records of discharge data recorded by field dataloggers. The data was obtained from three states varying in latitude along the East Coast (i.e., Florida, North Carolina, and New York). Stream gage locations were selected based on proximity to major river basins and vulnerable counties susceptible to hurricane impacts. Additionally, gage locations were specifically chosen with sufficient data, going back to at least the 1990s. Similar timeline ranges for the datatsets ensures a time series analysis that is comparable among all three sites. Discharge data was the data type used in this analysis with all datasets having at minimum daily recordings but some having recordings as often as every 30 minutes. 

\newpage

#Data Wrangling

Downloaded datasets included date/time and mean discharge (cfs) columns. After the date column was properly classified as a date, unnecessary columns were removed from the data frame. Next, the date column was separated out to filter for years 1990-2021 and to filter for hurricane months (June-October). The dataset was then saved into the processed folder for each of the research locations. Missing data values were then filled using a linear interpolation and then daily averages of discharge were created in a new, clean column of daily means. After all fo these steps were taken the data was considered to be wrangled and was then ready for initial visualizations. 

```{r NY Wrangle, include=FALSE}
#Wrangle Data

# filling missing data with linear interpolation
NY_Daily.Discharge.Clean <-
  NY_Discharge %>%
  mutate(MeanDischargeClean = zoo::na.approx(X104599_00060_00003))
view(NY_Daily.Discharge.Clean)


#Wrangle Data
NY_Discharge.processed <-
  NY_Daily.Discharge.Clean %>%
  rename(Agency = agency_,
         SiteNumber = cd.......site_no,
         MeanDischarge = MeanDischargeClean) %>%
  select(Agency, SiteNumber, MeanDischarge, Month, Date, Year) %>%
  filter(Month > 5, Month < 11,
         Date >= "1990-06-01")
view(NY_Discharge.processed)



#saving processed file as a csv
write.csv(NY_Discharge.processed, "./Data/Processed/NY_DischargeData_Processed", row.names = FALSE)

```

```{r NC Wrangle, include=FALSE}
# initial tidying of dataset
NewRiver.Discharge.RAW <- NewRiver.Discharge.RAW[-c(1), ] #removing non-data row

NewRiver.Discharge.PROC <- NewRiver.Discharge.RAW %>% 
                        select(agency_cd, site_no, 
                               X89345_00060, X89346_00065, Date) #selecting necessary columns

colnames(NewRiver.Discharge.PROC) <- c("Agency", "Site_No",
                            "Discharge_cfs", "GageHeight_ft", "Date") #changing column names
  
# setting discharge and gage height columns as numeric
NewRiver.Discharge.PROC$Discharge_cfs <- as.numeric(NewRiver.Discharge.PROC$Discharge_cfs)
NewRiver.Discharge.PROC$GageHeight_ft <- as.numeric(NewRiver.Discharge.PROC$GageHeight_ft)

NewRiver.Discharge.PROC <- NewRiver.Discharge.PROC %>% 
                        group_by(Date) %>%  #grouping by date
                        mutate(Year = year(Date), #creating year column
                               Month = month(Date), #creating month column
                               Day = day(Date)) %>% #creating day column
                        filter(Year >= 1990) %>% #filtering for data 1990 or later
                      filter(Month > 5 & Month < 11) #filtering for data in hurricane season

# saving processd file as csv
write.csv(NewRiver.Discharge.PROC, "./Data/Processed/NC_Discharge_NewRiver_PROC.csv", row.names = FALSE)
                        
# creating daily discharge dataset
NewRiver.Daily.DischargeGage <- NewRiver.Discharge.PROC %>%  
            summarise(MeanDailyDischarge_cfs = mean(Discharge_cfs), #daily mean discharge
                      MeanDailyGageHeight_ft = mean(GageHeight_ft)) #daily mean gage height

# filling missing data with linear interpolation
NewRiver.Daily.Discharge.Clean <-
  NewRiver.Daily.DischargeGage %>%
  mutate(Discharge_cfs_Clean = zoo::na.approx(MeanDailyDischarge_cfs))
```


\newpage

# Exploratory Analysis 

The exploratory analysis of the data involved creating a map of the USGS gage locations along the East Coast of the U.S. to orient individuals towards the locality of the research. Also, the initial visualizations of the discharge data for each research location-during hurricane seasons-was included in the exploratory analysis from ~1990-2021. After the initial graphs displayed  poorly visualized data, a log scale was applied to the y-axis in order to better present any noticeable trend that may be occurring. Comparing differences between the intensity, frequency, and shifts in these variables over time, permitted researchers to formulate predictions on possible changes in each research location as well as any changes over time. However, to fully understand these shifting trends, the following time series analysis was conducted. 

```{r map of locations, echo=FALSE, fig.cap='Locations'}
site_locations <- read.csv("./Data/Raw/Site_locations.csv", stringsAsFactors = T)
site_locations.sf <- site_locations %>%
st_as_sf(coords = c('Long','Lat'),
         crs=4269)
mapview(site_locations.sf[1,], zcol = "Site.Name", col.regions = "deeppink1") +
mapview(site_locations.sf[2,], zcol = "Site.Name", col.regions = "turquoise4") +
mapview(site_locations.sf[3,], zcol = "Site.Name", col.regions = "forestgreen")
```

```{r ex an FL, fig.cap='Florida Discharge (cfs) 1990-2021'}
#plot discharge before running time series on the log scale
ggplot(florida_hurricane_1990, aes(x = Date, y = log(Daily_Discharge_clean)))+
  geom_point(color = "deeppink1")+
  geom_smooth(method = lm, color = "black")+
  labs(x = "Date", y = "Mean Daily Discharge (cfs)",
       title = "Mean Daily Discharge During Hurrcane Seasons (1990-2021)", 
       subtitle = "North Prong St. Sebastian River, Florida") 
```

```{r ex an NC, fig.cap='North Carolina Discharge (cfs) 1990-2021'}
# initial data visualiation
DailyDischarge.Plot <- 
                ggplot(NewRiver.Daily.DischargeGage, aes(Date, MeanDailyDischarge_cfs)) +
                      geom_point(color = "forestgreen") +
                      geom_smooth(method = "lm", color = "black") +
                      labs(x = "Date", y = "Mean Daily Discharge (cfs)",
                        title = "Mean Daily Discharge During Hurrcane Seasons (1990-2021)", 
                           subtitle = "New River, North Carolina") +
                      theme(plot.title=element_text(hjust=0.5)) +
                      theme(plot.subtitle=element_text(hjust=0.5)) +
                      scale_y_log10()
DailyDischarge.Plot
```

```{r ex NY, fig.cap='New York Discharge (cfs) 1990-2021'}
NY_DailyDischargePlot <- ggplot(NY_Discharge.processed, aes(x = Date, y = MeanDischarge)) +
  scale_y_log10() +
  geom_point(color = "turquoise4", size = 0.7) +
  geom_smooth(method = lm, color = "black") +
  ylab("Daily Discharge (cfs)") +
  labs(title = paste("Daily Discharge During Hurricane Seasons (1990-2021)"), subtitle = paste("Cold Spring Harbor, New York")) +
  scale_x_date(date_labels = "%Y", date_breaks = "2 year") +
  theme(axis.text.x = element_text(angle = 90)) 

NY_DailyDischargePlot
```


\newpage

# Analysis

The analysis of these datasets centers on creating time series objects of the discharge data. These time series objects are then decomposed to analyze the trend, seasonality, and remainder for the data values. New dataframes were then created with these three aspects of the time series. Within these dataframes, the trend and remainder values for each data point were combined to create a "non-seasonal" discharge value in order to better understand the actual changes in hurricane intensity and frequency during the hurricane season.

These non-seasonal values were then used to create another time series object which was graphed to visualize potential trends that may be occurring in the data as well as the spread of the discharge values. The spread of the discharge values indicates differences in discharge which is a proxy for hurricane intensity. To analyze trends statistically, rather than visually, a Mann Kendall test was performed. The Mann Kendall test produced a tau value which indicated whether the trend was increasing or decreasing. The tau values were compared across all three research locations in addition to p-values which displayed statistical significance of the results. 

```{r NY analysis}

#NY Daily Discharge time-series
NY_DailyDischarge.ts <- ts(NY_Discharge.processed$MeanDischarge, start = c(1990,01), frequency = 153)
head(NY_DailyDischarge.ts, 10)

#Decompose
NY_DailyDischarge.decompose <- stl(NY_DailyDischarge.ts, s.window = "periodic")
plot(NY_DailyDischarge.decompose)


#Nonseasonal MannKendall
NY_Components <- as.data.frame(NY_DailyDischarge.decompose$time.series[,2:3])
view(NY_Components)

#Add in a date column
NY_Components <- mutate(NY_Components,
                        Date = NY_Discharge.processed$Date)

#Adding non-seasonal component to dataframe
NY_Combine_Nonseasonal <- mutate(NY_Components, Nonseasonal = NY_Components$trend + NY_Components$remainder)
view(NY_Combine_Nonseasonal)

#Nonseasonal time series
NY_Nonseasonal.ts <- ts(NY_Combine_Nonseasonal$Nonseasonal, start= c(1990, 1), frequency = 153)

#MannKendall Nonseasonal Analysis
NY_Trend.Nonseasonal <- Kendall::MannKendall(NY_Nonseasonal.ts)
NY_Trend.Nonseasonal

#tau = 0.13; p-value = less than 0.05
#the null hypothesis of the test (i.e., Seasonal Mann Kendall) states that the data is stationary
#reject null hypothesis and we state that there is a trend

#trying to create a plot for the ts but not working! (I'll try ggplot instead below as well)
#autoplot version
NY_NonSeasonal.Plot1 <- autoplot(NY_Nonseasonal.ts) +
  scale_y_log10() +
  labs(x = "Date", y = "Non-Seasonal Daily Discharge (cfs)", 
       title = "Non-Seasonal Mean Daily Discharge During Hurricane Seasons (1990-2021)", 
       subtitle = "Cold Spring Harbor, New York") +
  geom_smooth(method = "lm")
print(NY_NonSeasonal.Plot1)
 
#ggplot version (working)
NY_NonSeasonal.Plot2 <- ggplot(NY_Combine_Nonseasonal, aes(x = Date, y = Nonseasonal)) +
  scale_y_log10() +
  geom_point(color = "turquoise4", size = 0.6) +
  labs(x = "Date", y = "Non-Seasonal Daily Discharge (cfs)", 
       title = "Non-Seasonal Mean Daily Discharge During Hurricane Seasons", 
       subtitle = "Cold Spring Harbor, New York") +
  geom_smooth(method = "lm", color = "black") +
  scale_x_date(date_labels = "%Y", date_breaks = "2 year") +
  theme(axis.text.x = element_text(angle = 90)) 
                               
print(NY_NonSeasonal.Plot2)

```

```{r NC analysis}
# creating daily discharge time series
NewRiver.Daily.Discharge.ts <- ts(NewRiver.Daily.Discharge.Clean$Discharge_cfs_Clean,
                     start = c(1990, 06, 01), frequency = 153)

# decomposing daily time series
Daily.Discharge.decomp <- stl(NewRiver.Daily.Discharge.ts, s.window = "periodic")
plot(Daily.Discharge.decomp)

# adding components into a dataframe, removing seasonal component
Daily.Discharge.Components <- as.data.frame(Daily.Discharge.decomp$time.series[,2:3])

# adding trend and remainder for analysis
NonSeasonalDischarge.Daily <- mutate(Daily.Discharge.Components,
                                   Seasonality_Removed = Daily.Discharge.Components$trend +
                                     Daily.Discharge.Components$remainder)

# creating non-seasonal time series
NonSeasonal.DailyDischarge.ts <- ts(NonSeasonalDischarge.Daily$Seasonality_Removed,
                     start = c(1990, 06, 01), frequency = 153)

# adding date column to nonseasonal df
NonSeasonalDischarge.Daily <- NonSeasonalDischarge.Daily %>% 
                                mutate(Date = NewRiver.Daily.Discharge.Clean$Date)

# creating nonseasonal plot
NonSeasonal.Plot <- ggplot(NonSeasonalDischarge.Daily, aes(Date, Seasonality_Removed)) +
                      geom_point(color = "forestgreen", size = 0.6) +
                      scale_y_log10() +
                      geom_smooth(method = "lm", color = "black") +
                      labs(x = "Date", y = "Non-Seasonal Daily Discharge (cfs)", 
                        title = "Non-Seasonal Mean Daily Discharge During Hurricane Seasons",
                        subtitle = "New River, North Carolina") +
                      scale_x_date(date_labels = "%Y", date_breaks = "2 year") +
                      theme(axis.text.x = element_text(angle = 90)) 
NonSeasonal.Plot

# running Mann Kendall on time series with seasonality removed
MannKendall(NonSeasonal.DailyDischarge.ts)
```

```{r FL analysis}
#regular time series
florida_hurricane_ts <- ts(florida_hurricane_1990$Daily_Discharge_clean, start=c(1990,6), frequency = 153)  
florida_hurricane_ts

#decomposed time series
florida_hurricane_Decomposed <- stl(florida_hurricane_ts, s.window = "periodic")
plot(florida_hurricane_Decomposed)
#filtering out seasonal data
florida_hurricane_Decomposed_Components <- as.data.frame(florida_hurricane_Decomposed$time.series[,2:3])
florida_hurricane_Decomposed_Components <- florida_hurricane_Decomposed_Components %>%
  mutate(data = trend + remainder) 
#add date column
florida_hurricane_Decomposed_Components <- mutate(florida_hurricane_Decomposed_Components,
                        Date = florida_hurricane_1990$Date)

#run time series on new data with seasonal removed
nonseasonal_data_florida_ts <- ts(florida_hurricane_Decomposed_Components$data,
                                start=c(1990,6),
                                frequency=153) 
plot(nonseasonal_data_florida_ts)

#look for trend and significance 
florida_trend <- MannKendall(nonseasonal_data_florida_ts)
florida_trend
summary(florida_trend)

#plot of nonseasonal trend
FL_NonSeasonal.Plot <- ggplot(florida_hurricane_Decomposed_Components, aes(x = Date, y = data)) +
  scale_y_log10() +
  geom_point(color = "deeppink1", size = 0.6) +
  labs(x = "Date", y = "Non-Seasonal Daily Discharge (cfs)", 
       title = "Non-Seasonal Mean Daily Discharge During Hurricane Seasons", 
       subtitle = "North Prong St. Sebastian River, Florida") +
  geom_smooth(method = "lm", color = "black") +
  scale_x_date(date_labels = "%Y", date_breaks = "2 year") +
  theme(axis.text.x = element_text(angle = 90)) 
plot(FL_NonSeasonal.Plot)                               
```

```{r combined plot, fig.cap='Non-Seasaonl Discharge Plot for all Gage Sites (cfs)'}
# creating combined nonseasonal dataframe
Date.df <- as.data.frame(NY_Combine_Nonseasonal$Date)
NY.NonSeasonal.df <- as.data.frame(NY_Combine_Nonseasonal$Nonseasonal)
FL.NonSeasonal.df <- as.data.frame(florida_hurricane_Decomposed_Components$data)
NC.NonSeasonal.df <- as.data.frame(NonSeasonalDischarge.Daily$Seasonality_Removed)

Combined.Nonseasonal.DF <- merge(Date.df, NY.NonSeasonal.df, FL.NonSeasonal.df, NC.NonSeasonal.df)


combined_NonSeasonal.Plot <- ggplot(NULL) +
  scale_y_log10(limits = c(0.25, 1200)) +
  geom_point(data = NonSeasonalDischarge.Daily, aes(Date, Seasonality_Removed), 
             color = "forestgreen", alpha = 0.05) +
  geom_smooth(data = NonSeasonalDischarge.Daily, aes(Date, Seasonality_Removed),
              method = "lm", color = "forestgreen") +
  geom_point(data = florida_hurricane_Decomposed_Components, 
             aes(x = Date, y = data), color = "deeppink1", alpha = 0.05) +
  geom_smooth(data = florida_hurricane_Decomposed_Components, 
             aes(x = Date, y = data), method = "lm", color = "deeppink1") +
  geom_point(data = NY_Combine_Nonseasonal, aes(x = Date, y = Nonseasonal), 
             color = "turquoise4", alpha = 0.05) + 
  geom_smooth(data = NY_Combine_Nonseasonal, aes(x = Date, y = Nonseasonal), 
              method = "lm", color = "turquoise4") +
  labs(x = "Date", y = "Non-Seasonal Daily Discharge (cfs)", 
       title = "Non-Seasonal Mean Daily Discharge During Hurricane Seasons") +
  scale_x_date(date_labels = "%Y", date_breaks = "2 year") +
  theme(axis.text.x = element_text(angle = 90))
plot(combined_NonSeasonal.Plot)
```


\newpage

# Summary and Conclusions

A poleward hurricane trend is apparent based on the daily discharge values associated with hurricane months across the East Coast of the U.S.. Although discharge is noticeably greater in Florida and North Carolina, hurricane discharge trends are increasing in New York and North Carolina while the last 30 years yielded a slightly decreasing trend in Florida. The effect of poleward hurricane movement with increasing hurricane frequency/intensity could potentially lead to exacerbated natural disasters in northern states of the U.S.. Large urban centers such as New York City are not equipped to handle such severe rain events. Given the substantial amount of impervious surface cover attributed to urbanization, future disastrous flooding events are inevitable. Further research on the analysis could possibly include more sites along the East Coast to better comprehend the trends that may be occurring in terms of where hurricanes are becoming more/less frequent and intense. 

State           | Tau value     | P-value
--------------- | ------------- | ------------
New York        | 0.13          | =< 2.22e-16
North Carolina  | 0.0572        | =< 2.22e-16
Florida         | -0.0516       |  7.7953e-08



\newpage

# References
<add references here if relevant, otherwise delete this section> 
